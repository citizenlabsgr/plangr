<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Modal Grand Rapids</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-50 text-slate-900">
    <main class="max-w-md mx-auto px-4 py-6">


      <div class="space-y-4">
      <!-- Step 1: Destination -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <h2 class="font-semibold text-lg">Where are you going?</h2>
          <p class="text-sm text-slate-600 mt-1 italic">
            The is hard-coded for this prototype.
          </p>

          <label class="block mt-4 text-sm font-medium">Destination</label>
          <input
            id="destination"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 bg-slate-100"
            value="Founders Brewing Co."
            disabled
          />
        </section>

        <!-- Day and Time -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <h2 class="font-semibold text-lg">When are you arriving?</h2>
          <p class="text-sm text-slate-600 mt-1">
            If your schedule is flexible, this may open up cheaper and easier ways of getting to your destination.
          </p>

          <label class="block mt-4 text-sm font-medium">Day</label>
          <select
            id="daySelect"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white"
          >
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="monday">Monday</option>
            <option value="tuesday">Tuesday</option>
            <option value="wednesday">Wednesday</option>
            <option value="thursday">Thursday</option>
            <option value="friday">Friday</option>
            <option value="saturday">Saturday</option>
            <option value="sunday">Sunday</option>
          </select>

          <label class="block mt-4 text-sm font-medium">Time</label>
          <select
            id="timeSelect"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white"
          >
          </select>

          <label class="block mt-4 text-sm font-medium">Flexibility</label>
          
          <div class="mt-2">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Willing to arrive early</label>
              <span class="text-sm text-slate-600">
                <span id="earlyValue">-15</span> min
              </span>
            </div>
            <input
              id="earlySlider"
              type="range"
              min="0"
              max="60"
              step="5"
              value="15"
              class="w-full mt-2"
            />
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Willing to arrive late</label>
              <span class="text-sm text-slate-600">
                <span id="lateValue">+0</span> min
              </span>
            </div>
            <input
              id="lateSlider"
              type="range"
              min="0"
              max="60"
              step="5"
              value="0"
              class="w-full mt-2"
            />
        </div>
      </section>

      <!-- Step 2: Mode + People -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <h2 class="font-semibold text-lg">How are you leaving home?</h2>
          <p class="text-sm text-slate-600 mt-1">
            This can be combined with a secondary mode of transportation to save you time or money.
          </p>

          <label class="block mt-4 text-sm font-medium">Mode</label>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="drive">
              üöó Drive
            </button>
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="rideshare">
              üöï Rideshare
            </button>
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="transit">
              üöå The Rapid
            </button>
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="bike">
              üö≤ Bike
            </button>
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="micromobility">
              üõ¥ Lime
            </button>
            <button type="button" class="modeBtn rounded-lg border border-slate-300 py-2" data-mode="walk">
              üö∂ Walk
            </button>
          </div>

          <label class="block mt-4 text-sm font-medium">People</label>
          <div class="mt-2 flex items-center gap-2">
            <button
              class="w-10 h-10 rounded-lg border border-slate-300 bg-white"
              onclick="adjustPeople(-1)"
              aria-label="Decrease people"
            >
              ‚àí
            </button>
            <div
              id="peopleCount"
              class="flex-1 text-center font-semibold text-lg"
            >
              1
            </div>
            <button
              class="w-10 h-10 rounded-lg border border-slate-300 bg-white"
              onclick="adjustPeople(1)"
              aria-label="Increase people"
            >
              +
            </button>
        </div>
      </section>

      <!-- Step 3: Sliders -->
        <section id="preferencesSection" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <h2 id="preferencesHeading" class="font-semibold text-lg">What is your time and money budget?</h2>
          <p class="text-sm text-slate-600 mt-1">
            Adjust these limits to find the best options for you.
          </p>

          <!-- Walk distance -->
          <div id="walkBlock" class="mt-4">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Willing to walk to destination</label>
              <span class="text-sm text-slate-600">
                <span id="walkValue">0.5</span><span id="walkUnit"> miles</span>
              </span>
            </div>
            <input
              id="walkSlider"
              type="range"
              min="0"
              max="1.5"
              step="0.1"
              value="0.5"
              class="w-full mt-2 disabled:opacity-50 disabled:cursor-not-allowed"
            />
          </div>

          <!-- Parking time (only if driving) -->
          <div id="parkingBlock" class="mt-4">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Willing to hunt for parking</label>
              <span class="text-sm text-slate-600">
                <span id="parkingValue">10</span><span id="parkingUnit"> min</span>
              </span>
            </div>
            <input
              id="parkingSlider"
              type="range"
              min="0"
              max="20"
              value="10"
              class="w-full mt-2 disabled:opacity-50 disabled:cursor-not-allowed"
            />
          </div>

          <!-- Cost -->
          <div class="mt-4">
            <div class="flex items-center justify-between">
              <label id="costLabel" class="text-sm font-medium">Willing to pay</label>
              <span class="text-sm text-slate-600">
                <span id="costPrefix">$</span><span id="costValue">1.75</span>
              </span>
            </div>
            <input
              id="costSlider"
              type="range"
              min="0"
              max="50"
              value="1.75"
              step="0.25"
              class="w-full mt-2 disabled:opacity-50 disabled:cursor-not-allowed"
            />
          </div>
        </section>

        <!-- Other Modes -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
          <h2 id="otherModesHeading" class="font-semibold text-lg">Are you open to a secondary mode?</h2>
          <p id="otherModesDescription" class="text-sm text-slate-600 mt-1">
            In addition to {mode}, you can use these to potentially save time or money.
          </p>

          <div class="mt-4 space-y-3">
            <label id="willingDashLabel" class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="willingDash"
                class="w-5 h-5 rounded border-slate-300 text-slate-900 focus:ring-slate-900 disabled:opacity-50 disabled:cursor-not-allowed"
              />
              <div class="flex items-center gap-2">
                <span class="text-xl">üöê</span>
                <div>
                  <div class="font-medium">DASH</div>
                  <div class="text-sm text-slate-600">Free downtown shuttle</div>
                </div>
              </div>
            </label>

            <label id="willingRapidLabel" class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="willingRapid"
                class="w-5 h-5 rounded border-slate-300 text-slate-900 focus:ring-slate-900 disabled:opacity-50 disabled:cursor-not-allowed"
              />
              <div class="flex items-center gap-2">
                <span class="text-xl">üöå</span>
                <div>
                  <div class="font-medium">The Rapid</div>
                  <div class="text-sm text-slate-600">Public transit system</div>
                </div>
              </div>
            </label>

            <label id="willingLimeLabel" class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="willingLime"
                class="w-5 h-5 rounded border-slate-300 text-slate-900 focus:ring-slate-900 disabled:opacity-50 disabled:cursor-not-allowed"
              />
              <div class="flex items-center gap-2">
                <span class="text-xl">üõ¥</span>
                <div>
                  <div class="font-medium">Lime</div>
                  <div class="text-sm text-slate-600">Scooter or bike rental</div>
                </div>
          </div>
            </label>
        </div>
      </section>

      <!-- Step 4: Results -->
        <div class="mt-8 pt-8 border-t-2 border-slate-300 -mx-4">
          <div id="results" class="space-y-3"></div>
        </div>
        
        </div>
    </main>

    <script>
      // Calculate default time: current time + 2 hours, rounded to nearest half hour
      // Minimum time is 5pm (17:00), maximum is 11pm (23:00)
      function getDefaultTime() {
        const now = new Date();
        const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
        let hour = twoHoursLater.getHours();
        let minutes = twoHoursLater.getMinutes();
        // Round to nearest half hour
        if (minutes < 15) {
          minutes = 0;
        } else if (minutes < 45) {
          minutes = 30;
        } else {
          minutes = 0;
          hour = (hour + 1) % 24;
        }
        // Ensure time is between 5pm and 11pm
        if (hour < 17) {
          hour = 17;
          minutes = 0;
        } else if (hour > 23 || (hour === 23 && minutes > 0)) {
          hour = 23;
          minutes = 0;
        }
        return String(hour).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
      }

      // Generate time options for dropdown (half-hour increments, starting at 5pm, ending at 11pm)
      function generateTimeOptions() {
        const timeSelect = document.getElementById("timeSelect");
        const options = [];
        // Start at 5pm (17:00) and go through 11pm (23:00)
        for (let hour = 17; hour <= 23; hour++) {
          for (let minute of [0, 30]) {
            // Skip 11:30pm, only go up to 11:00pm
            if (hour === 23 && minute === 30) break;
            const timeValue = String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
            const timeDisplay = new Date(`2000-01-01T${timeValue}`).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            options.push(`<option value="${timeValue}">${timeDisplay}</option>`);
          }
        }
        timeSelect.innerHTML = options.join('');
      }

      const defaultTime = getDefaultTime();

      const state = {
        destination: "Founders Brewing Co.",
        day: "today",
        time: defaultTime,
        flexibilityEarlyMins: 15,
        flexibilityLateMins: 0,
        mode: "drive",
        people: 1,
        walkMiles: 0.5,
        parkingMins: 10,
        costDollars: 1.75,
        willingToUseDash: false,
        willingToUseRapid: false,
        willingToUseLime: false,
      };

      // Valid modes
      const validModes = ["drive", "rideshare", "transit", "bike", "micromobility", "walk"];

      // Track if day/time/people have been changed from defaults
      let dayChanged = false;
      let timeChanged = false;
      let peopleChanged = false;

      // Convert time from HH:MM to HHMM for URL (avoids %3A encoding)
      function timeToUrl(time) {
        return time.replace(':', '');
      }

      // Convert time from HHMM to HH:MM from URL
      function timeFromUrl(urlTime) {
        if (urlTime.length === 4) {
          return urlTime.slice(0, 2) + ':' + urlTime.slice(2);
        }
        return urlTime; // Fallback if already in HH:MM format
      }

      // Parse URL fragment (format: #mode=drive&day=today&time=1800&people=2)
      function parseFragment() {
        const hash = window.location.hash.slice(1); // Remove the #
        if (!hash) return {};
        
        const params = {};
        hash.split('&').forEach(param => {
          const [key, value] = param.split('=');
          if (key && value) {
            if (key === 'time') {
              // Convert time from URL format (HHMM) to state format (HH:MM)
              params[key] = timeFromUrl(decodeURIComponent(value));
            } else {
              params[key] = decodeURIComponent(value);
            }
          }
        });
        return params;
      }

      // Update URL fragment with current state
      function updateFragment() {
        const parts = [];
        if (state.mode) parts.push(`mode=${encodeURIComponent(state.mode)}`);
        // Only include day/time/people in fragment if they've been changed by user
        if (dayChanged && state.day) {
          parts.push(`day=${encodeURIComponent(state.day)}`);
        }
        if (timeChanged && state.time) {
          // Convert time to URL format without colon
          parts.push(`time=${timeToUrl(state.time)}`);
        }
        if (peopleChanged && state.people) {
          parts.push(`people=${encodeURIComponent(state.people)}`);
        }
        window.location.hash = parts.length > 0 ? parts.join('&') : '';
      }

      // Update results whenever state changes
      function updateResults() {
        renderResults();
        updateDirectionsLink();
      }

      // Get mode display name
      function getModeLabel(mode) {
        const labels = {
          drive: "driving",
          rideshare: "rideshare",
          transit: "The Rapid",
          bike: "biking",
          micromobility: "Lime",
          walk: "walking"
        };
        return labels[mode] || mode;
      }

      // Get cost label based on mode
      function getCostLabel(mode) {
        const labels = {
          drive: "Willing to pay for parking",
          rideshare: "Willing to pay for ride",
          transit: "Willing to pay for fare",
          bike: "Willing to pay",
          micromobility: "Willing to pay for rental",
          walk: "Willing to pay"
        };
        return labels[mode] || "Willing to pay";
      }

      // Update preferences visibility based on mode
      function updateDirectionsLink() {
        const directionsLink = document.getElementById("directionsLink");
        const directionsLinkText = document.getElementById("directionsLinkText");
        if (!directionsLink || !directionsLinkText) return;

        const destination = encodeURIComponent(state.destination + ", Grand Rapids, MI");
        let linkUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
        let linkText = "Get directions on Google Maps";

        // Update link based on mode
        switch (state.mode) {
          case "drive":
            // Link to parking near destination
            linkUrl = `https://www.google.com/maps/search/?api=1&query=parking+near+${destination}`;
            linkText = "Find parking near destination";
            break;
          case "bike":
            // Link to bike racks near destination
            linkUrl = `https://www.google.com/maps/search/?api=1&query=bike+rack+near+${destination}`;
            linkText = "Find bike rack near destination";
            break;
          case "transit":
            // Link to transit stops near destination
            linkUrl = `https://www.google.com/maps/search/?api=1&query=transit+stop+near+${destination}`;
            linkText = "Find transit stop near destination";
            break;
          case "micromobility":
            // Link to destination (Lime scooters can be found via app)
            linkText = "Get directions to destination";
            break;
          case "rideshare":
            // Link to destination (rideshare drop-off)
            linkText = "Get directions to destination";
            break;
          case "walk":
            // Link to destination
            linkText = "Get directions to destination";
            break;
          default:
            linkText = "Get directions on Google Maps";
        }

        directionsLink.href = linkUrl;
        directionsLinkText.textContent = linkText;
      }

      function updatePreferencesVisibility() {
        const walkSlider = document.getElementById("walkSlider");
        const parkingSlider = document.getElementById("parkingSlider");
        const costSlider = document.getElementById("costSlider");
        const walkValue = document.getElementById("walkValue");
        const walkUnit = document.getElementById("walkUnit");
        const parkingValue = document.getElementById("parkingValue");
        const parkingUnit = document.getElementById("parkingUnit");
        const costValue = document.getElementById("costValue");
        const costPrefix = document.getElementById("costPrefix");
        const costLabel = document.getElementById("costLabel");
        
        // Parking slider: only enabled for drive mode
        const parkingDisabled = state.mode !== "drive";
        parkingSlider.disabled = parkingDisabled;
        if (parkingDisabled) {
          parkingValue.textContent = "‚Äî";
          parkingUnit.textContent = "";
        } else {
          parkingValue.textContent = state.parkingMins;
          parkingUnit.textContent = " min";
        }
        
        // Walk slider: disabled for rideshare and walk modes
        const walkDisabled = state.mode === "rideshare" || state.mode === "walk";
        walkSlider.disabled = walkDisabled;
        if (walkDisabled) {
          walkValue.textContent = "‚Äî";
          walkUnit.textContent = "";
        } else {
          walkValue.textContent = state.walkMiles.toFixed(1);
          walkUnit.textContent = " miles";
        }
        
        // Cost slider: disabled for walk and bike modes
        const costDisabled = state.mode === "walk" || state.mode === "bike";
        costSlider.disabled = costDisabled;
        if (costDisabled) {
          costValue.textContent = "‚Äî";
          costPrefix.textContent = "";
        } else {
          // For transit and micromobility, show total cost (per-person * people), otherwise show per-person cost
          const displayCost = (state.mode === "transit" || state.mode === "micromobility")
            ? state.costDollars * state.people 
            : state.costDollars;
          // Format to 2 decimal places, but show as integer if it's a whole number
          costValue.textContent = displayCost % 1 === 0 
            ? displayCost 
            : displayCost.toFixed(2);
          costPrefix.textContent = "$";
        }
        
        // Update cost label based on mode
        costLabel.textContent = getCostLabel(state.mode);
        
        // Gray out entire section if all preferences are disabled (e.g., walk mode)
        const allDisabled = parkingDisabled && walkDisabled && costDisabled;
        const preferencesSection = document.getElementById("preferencesSection");
        const preferencesHeading = document.getElementById("preferencesHeading");
        if (preferencesSection) {
          preferencesSection.classList.toggle("opacity-50", allDisabled);
        }
        if (preferencesHeading) {
          preferencesHeading.classList.toggle("opacity-50", allDisabled);
        }
        
        // Other modes checkboxes: only enabled for drive and transit
        const otherModesEnabled = state.mode === "drive" || state.mode === "transit";
        const willingDash = document.getElementById("willingDash");
        const willingRapid = document.getElementById("willingRapid");
        const willingLime = document.getElementById("willingLime");
        const willingDashLabel = document.getElementById("willingDashLabel");
        const willingRapidLabel = document.getElementById("willingRapidLabel");
        const willingLimeLabel = document.getElementById("willingLimeLabel");
        
        if (willingDash) {
          willingDash.disabled = !otherModesEnabled;
          if (willingDashLabel) {
            willingDashLabel.classList.toggle("opacity-50", !otherModesEnabled);
            willingDashLabel.classList.toggle("cursor-not-allowed", !otherModesEnabled);
            willingDashLabel.classList.toggle("cursor-pointer", otherModesEnabled);
          }
        }
        
        if (willingRapid) {
          // Disable if other modes are disabled OR if transit is the current mode
          const rapidDisabled = !otherModesEnabled || state.mode === "transit";
          willingRapid.disabled = rapidDisabled;
          if (willingRapidLabel) {
            willingRapidLabel.classList.toggle("opacity-50", rapidDisabled);
            willingRapidLabel.classList.toggle("cursor-not-allowed", rapidDisabled);
            willingRapidLabel.classList.toggle("cursor-pointer", !rapidDisabled);
          }
        }
        
        if (willingLime) {
          willingLime.disabled = !otherModesEnabled;
          if (willingLimeLabel) {
            willingLimeLabel.classList.toggle("opacity-50", !otherModesEnabled);
            willingLimeLabel.classList.toggle("cursor-not-allowed", !otherModesEnabled);
            willingLimeLabel.classList.toggle("cursor-pointer", otherModesEnabled);
          }
        }
        
        // Gray out heading and description when disabled
        const otherModesHeading = document.getElementById("otherModesHeading");
        const otherModesDescription = document.getElementById("otherModesDescription");
        if (otherModesHeading) {
          otherModesHeading.classList.toggle("opacity-50", !otherModesEnabled);
        }
        if (otherModesDescription) {
          otherModesDescription.classList.toggle("opacity-50", !otherModesEnabled);
          // Update description text
          if (otherModesEnabled) {
            const modeLabel = getModeLabel(state.mode);
            otherModesDescription.textContent = `In addition to ${modeLabel}, you can use these to potentially save time or money.`;
          }
        }
      }

      // Set mode and update UI
      function setMode(mode) {
        if (!validModes.includes(mode)) return;
        state.mode = mode;
        // Set default cost based on mode
        if (mode === "micromobility" && (state.costDollars === 1.75 || state.costDollars === 15)) {
          // If switching from transit or rideshare default, set to micromobility default
          state.costDollars = 4;
          costSlider.value = 4;
        } else if (mode === "transit" && (state.costDollars === 4 || state.costDollars === 15)) {
          // If switching from micromobility or rideshare default, set to transit default
          state.costDollars = 1.75;
          costSlider.value = 1.75;
        } else if (mode === "rideshare" && (state.costDollars === 1.75 || state.costDollars === 4)) {
          // If switching from transit or micromobility default, set to rideshare default
          state.costDollars = 15;
          costSlider.value = 15;
        }
        highlightMode();
        updatePreferencesVisibility();
        updateResults();
        updateFragment();
      }

      // Handle browser back/forward navigation
      window.addEventListener("hashchange", () => {
        const params = parseFragment();
        if (params.mode !== undefined && params.mode !== state.mode) {
          if (params.mode && validModes.includes(params.mode)) {
            state.mode = params.mode;
            highlightMode();
            updatePreferencesVisibility();
          } else if (!params.mode) {
            state.mode = "";
          highlightMode();
            updatePreferencesVisibility();
          }
        }
        if (params.day !== undefined && params.day !== state.day) {
          state.day = params.day || "";
          daySelect.value = state.day;
          dayChanged = true;
        }
        if (params.time !== undefined && params.time !== state.time) {
          state.time = params.time || "";
          timeSelect.value = state.time;
          timeChanged = true;
        }
        if (params.people !== undefined && params.people !== state.people) {
          const peopleValue = Number(params.people);
          if (peopleValue >= 1 && peopleValue <= 6) {
            state.people = peopleValue;
            document.getElementById("peopleCount").textContent = state.people;
            peopleChanged = true;
          }
        }
        updateResults();
        // Don't update fragment here to avoid loop
      });

      function highlightMode() {
        document.querySelectorAll(".modeBtn").forEach((btn) => {
          const active = btn.dataset.mode === state.mode;
          btn.classList.toggle("bg-slate-900", active);
          btn.classList.toggle("text-white", active);
          btn.classList.toggle("border-slate-900", active);
        });
      }

      function adjustPeople(delta) {
        state.people = Math.max(1, Math.min(6, state.people + delta));
        document.getElementById("peopleCount").textContent = state.people;
        peopleChanged = true;
        // Always update preferences visibility to refresh cost display (shows total for transit/micromobility)
        updatePreferencesVisibility();
        updateFragment();
        updateResults();
      }

      // Sliders
      const walkSlider = document.getElementById("walkSlider");
      const parkingSlider = document.getElementById("parkingSlider");
      const costSlider = document.getElementById("costSlider");

      walkSlider.addEventListener("input", (e) => {
        state.walkMiles = Number(e.target.value);
        const walkValue = document.getElementById("walkValue");
        const walkUnit = document.getElementById("walkUnit");
        if (!walkSlider.disabled) {
          walkValue.textContent = state.walkMiles.toFixed(1);
          walkUnit.textContent = " miles";
        }
        updateResults();
      });

      parkingSlider.addEventListener("input", (e) => {
        state.parkingMins = Number(e.target.value);
        const parkingValue = document.getElementById("parkingValue");
        const parkingUnit = document.getElementById("parkingUnit");
        if (!parkingSlider.disabled) {
          parkingValue.textContent = state.parkingMins;
          parkingUnit.textContent = " min";
        }
        updateResults();
      });

      costSlider.addEventListener("input", (e) => {
        state.costDollars = Number(e.target.value);
        const costValue = document.getElementById("costValue");
        const costPrefix = document.getElementById("costPrefix");
        if (!costSlider.disabled) {
          // For transit and micromobility, show total cost (per-person * people), otherwise show per-person cost
          const displayCost = (state.mode === "transit" || state.mode === "micromobility")
            ? state.costDollars * state.people 
            : state.costDollars;
          // Format to 2 decimal places, but show as integer if it's a whole number
          costValue.textContent = displayCost % 1 === 0 
            ? displayCost 
            : displayCost.toFixed(2);
          costPrefix.textContent = "$";
        }
        updateResults();
      });

      // Day and Time inputs
      const daySelect = document.getElementById("daySelect");
      const timeSelect = document.getElementById("timeSelect");
      const earlySlider = document.getElementById("earlySlider");
      const lateSlider = document.getElementById("lateSlider");

      daySelect.addEventListener("change", (e) => {
        state.day = e.target.value;
        dayChanged = true;
        updateFragment();
        updateResults();
      });

      timeSelect.addEventListener("change", (e) => {
        state.time = e.target.value;
        timeChanged = true;
        updateFragment();
        updateResults();
      });

      earlySlider.addEventListener("input", (e) => {
        state.flexibilityEarlyMins = Number(e.target.value);
        document.getElementById("earlyValue").textContent = `-${state.flexibilityEarlyMins}`;
        updateResults();
      });

      lateSlider.addEventListener("input", (e) => {
        state.flexibilityLateMins = Number(e.target.value);
        document.getElementById("lateValue").textContent = `+${state.flexibilityLateMins}`;
        updateResults();
      });

      // Other modes checkboxes
      const willingDash = document.getElementById("willingDash");
      const willingRapid = document.getElementById("willingRapid");
      const willingLime = document.getElementById("willingLime");

      willingDash.addEventListener("change", (e) => {
        state.willingToUseDash = e.target.checked;
        updateResults();
      });

      willingRapid.addEventListener("change", (e) => {
        state.willingToUseRapid = e.target.checked;
        updateResults();
      });

      willingLime.addEventListener("change", (e) => {
        state.willingToUseLime = e.target.checked;
        updateResults();
      });

      function renderResults() {
        const resultsEl = document.getElementById("results");
        resultsEl.innerHTML = "";

        const { primary, alternate } = buildRecommendation();

        if (!primary) return;

        // Render primary recommendation (green or red if no options)
          const card = document.createElement("div");
        const isNoOptions = primary.isNoOptions;
        card.className = isNoOptions 
          ? "rounded-none bg-red-50 border border-red-200 p-6"
          : "rounded-none bg-green-50 border border-green-200 p-6";
        
        const recommendation = primary;

        // If there are steps, make them the primary focus
        if (isNoOptions) {
          card.innerHTML = `
            <div class="space-y-4">
              <div>
                <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">No Options Available</div>
                <h3 class="font-semibold text-xl">${recommendation.title}</h3>
                ${recommendation.body ? `<p class="text-sm text-slate-600 mt-2">${recommendation.body}</p>` : ''}
              </div>
            </div>
          `;
        } else if (recommendation.steps && recommendation.steps.length > 0) {
          card.innerHTML = `
            <div class="space-y-4">
              <div>
                <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Recommended Strategy</div>
                <h3 class="font-semibold text-xl">${recommendation.title}</h3>
                ${recommendation.body ? `<p class="text-sm text-slate-600 mt-2">${recommendation.body}</p>` : ''}
              </div>
              <div class="space-y-4">
                <div class="text-sm font-semibold text-slate-700">Follow these steps:</div>
                <ol class="space-y-4">
                  ${recommendation.steps.map((step, index) => `
                    <li class="flex gap-4">
                      <span class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold flex items-center justify-center">${index + 1}</span>
                      <div class="flex-1 pt-1">
                        <div class="font-semibold text-base text-slate-900">${step.title}</div>
                        ${step.description ? `<div class="text-sm text-slate-600 mt-2 leading-relaxed">${step.description}</div>` : ''}
                        ${step.link ? `<a href="${step.link}" target="_blank" rel="noopener noreferrer" class="mt-2 inline-block text-sm text-blue-600 hover:text-blue-800 underline">${step.linkText || 'Open link'} ‚Üí</a>` : ''}
                      </div>
                    </li>
                  `).join('')}
                </ol>
              </div>
            </div>
          `;
        } else {
          // Single step instruction format
          card.innerHTML = `
            <div class="space-y-4">
              <div>
                <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Recommended Strategy</div>
                <h3 class="font-semibold text-xl">${recommendation.title}</h3>
              </div>
              <div class="space-y-4">
                <div class="flex gap-4">
                  <span class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold flex items-center justify-center">1</span>
                  <div class="flex-1 pt-1">
                    <div class="font-semibold text-base text-slate-900">${recommendation.instruction || recommendation.title}</div>
                    ${recommendation.body ? `<div class="text-sm text-slate-600 mt-2 leading-relaxed">${recommendation.body}</div>` : ''}
                  </div>
                </div>
              </div>
              ${recommendation.meta ? `<div class="pt-4 border-t border-slate-200 text-xs text-slate-500">${recommendation.meta}</div>` : ''}
            </div>
          `;
        }

          resultsEl.appendChild(card);

        // Render alternate recommendation (yellow) if applicable
        if (alternate) {
          const altCard = document.createElement("div");
          altCard.className = "rounded-none bg-yellow-50 border border-yellow-200 p-6 mt-4";
          
          if (alternate.steps && alternate.steps.length > 0) {
            altCard.innerHTML = `
              <div class="space-y-4">
                <div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Alternate Strategy</div>
                  <h3 class="font-semibold text-xl">${alternate.title}</h3>
                  ${alternate.body ? `<p class="text-sm text-slate-600 mt-2">${alternate.body}</p>` : ''}
                </div>
                <div class="space-y-4">
                  <div class="text-sm font-semibold text-slate-700">Follow these steps:</div>
                  <ol class="space-y-4">
                    ${alternate.steps.map((step, index) => `
                      <li class="flex gap-4">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold flex items-center justify-center">${index + 1}</span>
                        <div class="flex-1 pt-1">
                          <div class="font-semibold text-base text-slate-900">${step.title}</div>
                          ${step.description ? `<div class="text-sm text-slate-600 mt-2 leading-relaxed">${step.description}</div>` : ''}
                          ${step.link ? `<a href="${step.link}" target="_blank" rel="noopener noreferrer" class="mt-2 inline-block text-sm text-blue-600 hover:text-blue-800 underline">${step.linkText || 'Open link'} ‚Üí</a>` : ''}
                        </div>
                      </li>
                    `).join('')}
                  </ol>
                </div>
              </div>
            `;
          } else {
            altCard.innerHTML = `
              <div class="space-y-4">
                <div>
                  <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Alternate Strategy</div>
                  <h3 class="font-semibold text-xl">${alternate.title}</h3>
                </div>
                <div class="space-y-4">
                  <div class="flex gap-4">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold flex items-center justify-center">1</span>
                    <div class="flex-1 pt-1">
                      <div class="font-semibold text-base text-slate-900">${alternate.instruction || alternate.title}</div>
                      ${alternate.body ? `<div class="text-sm text-slate-600 mt-2 leading-relaxed">${alternate.body}</div>` : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          
          resultsEl.appendChild(altCard);
        }
      }

      function buildRecommendation() {
        const { mode, people, walkMiles, parkingMins, costDollars, willingToUseDash, willingToUseRapid, willingToUseLime } = state;
        
        if (!mode) return { primary: null, alternate: null };

        // For transit and micromobility, calculate total cost (per-person * people)
        const totalCost = (mode === "transit" || mode === "micromobility") 
          ? costDollars * people 
          : costDollars;

        const steps = [];
        let recommendation = {};
        let alternate = null;

        // Build primary recommendation and steps based on mode
        if (mode === "drive") {
          if (willingToUseDash) {
            recommendation = {
              title: "Park farther, use DASH for last mile",
              body: "Park in a less crowded area and take the free DASH shuttle to get closer to your destination.",
              meta: `Walk: up to ${walkMiles.toFixed(1)} miles`,
              badge: "Time saver",
            };
            steps.push(
              { title: "Park farther from destination", description: `Find parking away from the destination where spots are easier to find. Look for areas with less competition.` },
              { title: "Take the DASH shuttle", description: "Walk to the nearest DASH stop and board the free downtown shuttle. Ride it to get closer to your destination." }
            );
          } else if (willingToUseRapid) {
            recommendation = {
              title: "Park at Rapid stop, take transit",
              body: "Park near a Rapid transit stop and take the bus to get closer to your destination.",
              meta: `Walk: up to ${walkMiles.toFixed(1)} miles`,
              badge: "Cost saver",
            };
            steps.push(
              { title: "Park near a Rapid stop", description: `Find parking near a Rapid transit stop. This area will have more available parking.` },
              { title: "Board The Rapid", description: "Walk to the Rapid stop and board the bus. Ride to a stop that's within walking distance of your destination." }
            );
          } else if (willingToUseLime) {
            recommendation = {
              title: "Park farther, use Lime for last mile",
              body: "Park in a less crowded area and use a Lime scooter or bike for the final stretch.",
              meta: `Walk: up to ${walkMiles.toFixed(1)} miles`,
              badge: "Flexible",
            };
            steps.push(
              { title: "Park farther from destination", description: `Find parking away from the destination where spots are easier to find. Look for areas with less competition.` },
              { title: "Find and ride a Lime scooter or bike", description: "Open the Lime app and locate the nearest available scooter or bike. Unlock it and ride directly to your destination." }
            );
          } else {
            // No secondary mode
            if (walkMiles === 0) {
              // No walk distance and no secondary modes - no options available
              recommendation = {
                title: "No options available",
                body: "You're driving but not willing to walk any distance and haven't selected any secondary modes. Consider adjusting your preferences to see recommendations.",
                isNoOptions: true
              };
            } else {
              // Use Founders parking lot as primary
              recommendation = {
                title: "Park at Founders parking lot",
                body: "Use the Founders Brewing Co. parking lot and get your parking ticket validated at the destination.",
                meta: ``,
                badge: "Guaranteed",
              };
              const foundersParkingUrl = "https://www.google.com/maps/dir/?api=1&destination=Founders+Brewing+Co.+Parking,+Grand+Rapids,+MI";
              steps.push(
                { 
                  title: "Get directions to Founders parking lot", 
                  description: "Use Google Maps to navigate to the Founders Brewing Co. parking lot.",
                  link: foundersParkingUrl,
                  linkText: "Open in Google Maps"
                },
                { title: "Park in the lot", description: "Find an available parking spot in the Founders parking lot." },
                { title: "Get parking validated", description: `Go to ${state.destination} and get your parking validated.` }
              );
              
              // Alternate strategy: Park farther and walk (if willing to walk)
              if (walkMiles > 0) {
                const altSteps = [];
                altSteps.push(
                  { title: "Park farther from destination", description: "Find parking away from the destination where spots are easier to find. Look for areas with less competition." },
                  { title: "Walk to destination", description: "Walk from your parking spot to your destination." }
                );
                alternate = {
                  title: "Park farther and walk",
                  body: "Park in a less crowded area and walk the rest of the way to your destination.",
                  steps: altSteps
                };
              }
            }
          }
        } else if (mode === "transit") {
          const transitUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(state.destination + ", Grand Rapids, MI")}&travelmode=transit`;
          if (costDollars === 0) {
            // No budget for transit - no options available
            recommendation = {
              title: "No options available",
              body: "You're taking The Rapid but not willing to pay any amount. Consider adjusting your budget to see recommendations.",
              isNoOptions: true
            };
          } else if (willingToUseDash) {
            recommendation = {
              title: "Take Rapid, then DASH",
              body: "Ride The Rapid to downtown, then use the free DASH shuttle to get closer to your destination.",
              meta: `Walk: up to ${walkMiles.toFixed(1)} miles ‚Ä¢ People: ${people}`,
              badge: "Efficient",
            };
            steps.push(
              { title: "Board The Rapid", description: "Go to your nearest Rapid stop and board the bus. Ride to a downtown stop that's near a DASH connection point.", link: transitUrl, linkText: "View transit route on Google Maps" },
              { title: "Transfer to DASH", description: "Get off The Rapid and walk to the nearest DASH stop. Board the free DASH shuttle and ride it closer to your destination." }
            );
          } else if (willingToUseLime) {
            recommendation = {
              title: "Take Rapid, then Lime",
              body: "Ride The Rapid to a stop near your destination, then use a Lime scooter or bike for the final stretch.",
              meta: `Walk: up to ${walkMiles.toFixed(1)} miles ‚Ä¢ People: ${people}`,
              badge: "Flexible",
            };
            steps.push(
              { title: "Board The Rapid", description: `Go to your nearest Rapid stop and board the bus. Ride to a stop near your destination.`, link: transitUrl, linkText: "View transit route on Google Maps" },
              { title: "Find and ride a Lime scooter or bike", description: "Get off The Rapid and open the Lime app. Locate the nearest available scooter or bike, unlock it, and ride to your destination." }
            );
          } else {
            if (walkMiles === 0) {
              // No walk distance and no secondary modes - no options available
              recommendation = {
                title: "No options available",
                body: "You're taking The Rapid but not willing to walk any distance and haven't selected any secondary modes. Consider adjusting your preferences to see recommendations.",
                isNoOptions: true
              };
            } else {
              recommendation = {
                title: "The Rapid + short walk",
                body: `Plan your route to a Rapid stop near your destination. Avoid transfers if possible. After getting off, walk the remaining distance.`,
                meta: `Walk tolerance: ${walkMiles.toFixed(1)} miles ‚Ä¢ People: ${people}`,
                badge: "Chill",
              };
              steps.push(
                { title: "Take The Rapid", description: `Go to your nearest Rapid stop and board the bus. Ride to a stop near your destination. Avoid transfers if possible.`, link: transitUrl, linkText: "View transit route on Google Maps" },
                { title: "Walk to destination", description: "Get off The Rapid and walk the remaining distance to your destination." }
              );
            }
          }
        } else if (mode === "walk") {
          recommendation = {
            title: "Walk directly to your destination",
            body: `Plan a route that prioritizes comfort and safety. Use sidewalks, crosswalks, and well-lit paths.`,
            meta: `Walk tolerance: ${walkMiles.toFixed(1)} miles ‚Ä¢ People: ${people}`,
            badge: "Simple",
          };
          steps.push(
            { title: "Plan your walking route", description: `Choose a path that uses sidewalks, crosswalks, and well-lit areas. Prioritize safety and comfort.` },
            { title: "Walk to destination", description: "Follow your planned route and walk directly to your destination." }
          );
        } else if (mode === "bike") {
          recommendation = {
            title: "Bike to your destination and lock up nearby",
            body: `Ride your bike to your destination. Find a bike rack or secure post near the entrance to lock up. This avoids parking entirely.`,
            meta: `Walk: ${walkMiles.toFixed(1)} miles`,
            badge: "No parking",
          };
          steps.push(
            { title: "Ride your bike to destination", description: `Ride your bike to your destination.` },
            { title: "Lock up your bike", description: "Find a bike rack or secure post near the entrance and lock up your bike." }
          );
        } else if (mode === "rideshare") {
          if (costDollars === 0) {
            // No budget for rideshare - no options available
            recommendation = {
              title: "No options available",
              body: "You're requesting a rideshare but not willing to pay any amount. Consider adjusting your budget to see recommendations.",
              isNoOptions: true
            };
          } else {
            recommendation = {
              title: "Request a rideshare to your destination",
              body: `Request a rideshare and get dropped off at your destination.`,
              meta: `People: ${people}`,
              badge: "Door-to-door",
            };
            steps.push(
              { title: "Request a rideshare", description: `Open your rideshare app (Uber, Lyft, etc.) and request a ride. Set your destination and confirm the ride.` },
              { title: "Arrive at destination", description: "Wait for your driver to arrive, then ride to your destination. The driver will drop you off as close as possible." }
            );
          }
        } else if (mode === "micromobility") {
          if (costDollars === 0) {
            // No budget for micromobility - no options available
            recommendation = {
              title: "No options available",
              body: "You're looking for a Lime scooter or bike but not willing to pay any amount. Consider adjusting your budget to see recommendations.",
              isNoOptions: true
            };
          } else {
            recommendation = {
              title: "Find and ride a Lime scooter or bike",
              body: `Open the Lime app and find the nearest available scooter or bike. Unlock it and ride directly to your destination.`,
              meta: `Walk: ${walkMiles.toFixed(1)} miles`,
              badge: "On-demand",
            };
            steps.push(
              { title: "Find a Lime scooter or bike", description: `Open the Lime app and locate the nearest available scooter or bike near your starting location.` },
              { title: "Ride to destination", description: "Unlock the scooter or bike and ride directly to your destination." }
            );
          }
        }

        recommendation.steps = steps;
        return { primary: recommendation, alternate: alternate };
      }

      // init
      // Read from URL fragment
      const params = parseFragment();
      if (params.mode && validModes.includes(params.mode)) {
        state.mode = params.mode;
        // Set default cost based on mode
        if (state.mode === "micromobility" && state.costDollars === 1.75) {
          state.costDollars = 4;
        } else if (state.mode === "rideshare" && state.costDollars === 1.75) {
          state.costDollars = 15;
        }
      } else if (state.mode === "micromobility") {
        // If default mode is micromobility, set cost to $4
        state.costDollars = 4;
      } else if (state.mode === "rideshare") {
        // If default mode is rideshare, set cost to $15
        state.costDollars = 15;
      }
      if (params.day) {
        state.day = params.day;
        dayChanged = true; // Mark as changed since it came from fragment
      }
      if (params.time) {
        state.time = params.time;
        timeChanged = true; // Mark as changed since it came from fragment
      }
      if (params.people) {
        const peopleValue = Number(params.people);
        if (peopleValue >= 1 && peopleValue <= 6) {
          state.people = peopleValue;
          peopleChanged = true; // Mark as changed since it came from fragment
        }
      }
      
      // Generate time options and initialize inputs
      generateTimeOptions();
      daySelect.value = state.day;
      timeSelect.value = state.time;
        document.getElementById("peopleCount").textContent = state.people;

      // Initialize other modes checkboxes
      if (willingDash) willingDash.checked = state.willingToUseDash;
      if (willingRapid) willingRapid.checked = state.willingToUseRapid;
      if (willingLime) willingLime.checked = state.willingToUseLime;
        costSlider.value = state.costDollars;
      earlySlider.value = state.flexibilityEarlyMins;
      lateSlider.value = state.flexibilityLateMins;
      document.getElementById("earlyValue").textContent = `-${state.flexibilityEarlyMins}`;
      document.getElementById("lateValue").textContent = `+${state.flexibilityLateMins}`;
      
      // Update Google Maps directions link
      updateDirectionsLink();
      
      // Attach mode button event listeners
      document.querySelectorAll(".modeBtn").forEach((btn) => {
        btn.addEventListener("click", function() {
          const mode = this.dataset.mode;
          if (mode) {
            setMode(mode);
          }
        });
      });
      
      highlightMode();
      updatePreferencesVisibility();
      renderResults();
    </script>
  </body>
</html>
